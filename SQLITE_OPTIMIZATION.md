# SQLite 效能優化說明

## 問題分析

專案中存在 SQLite 資源被重複查詢的問題，主要原因包括：

1. **圖表組件的 useEffect 依賴項不完整**
2. **缺少適當的查詢快取機制**
3. **沒有查詢去重和節流控制**
4. **ResultTableRow 中的頻繁重新查詢**

## 解決方案

### 1. 查詢快取系統 (`useQueryCache.ts`)

- 實作了全域查詢快取，避免相同查詢重複執行
- 設定 30 秒的快取過期時間
- 支援進行中查詢的重複利用

### 2. 統一圖表資料 Hook (`useChartData.ts`)

- 統一管理所有圖表組件的資料查詢邏輯
- 整合快取機制和錯誤處理
- 支援不同類型的圖表需求（日線、週線、小時線）

### 3. 資料庫查詢優化 (`useDatabaseQuery.ts`)

- 增加查詢節流機制，避免重複查詢
- 支援查詢中斷，避免無效查詢堆積
- 整合性能監控

### 4. 性能監控工具 (`DatabasePerformanceMonitor.ts`)

- 監控查詢頻率和執行時間
- 自動警告可能的重複查詢
- 提供查詢統計報告

### 5. 開發調試工具 (`DatabasePerformanceDebugger.tsx`)

- 僅在開發環境顯示
- 即時顯示查詢統計
- 方便開發者識別性能問題

## 已優化的組件

- `DailyUltraTinyLineChart.tsx`
- `WeeklyUltraTinyLineChart.tsx`
- `HourlyUltraTinyLineChart.tsx`
- `DailyKdLineChart.tsx`
- `ResultTableRow.tsx`

## 使用方式

### 查看性能統計（開發環境）

1. 右上角會顯示 "DB Stats" 按鈕，顯示總查詢數量
2. 點擊按鈕展開詳細統計資訊
3. 使用 "Log to Console" 將統計資料輸出到控制台
4. 使用 "Reset" 重置統計數據

### 監控指標

- **Count**: 查詢執行次數
- **Avg Time**: 平均執行時間
- **Total Time**: 總執行時間
- 紅色標示表示可能的重複查詢（次數 > 5）

## 預期效果

1. **減少 SQLite 資源消耗**: 通過快取和去重機制大幅減少重複查詢
2. **提升載入速度**: 快取的查詢結果能立即返回
3. **更好的用戶體驗**: 減少載入時間和資源競爭
4. **易於維護**: 統一的查詢邏輯便於後續維護和優化

## 注意事項

- 快取過期時間設定為 30 秒，可根據需求調整
- 性能監控工具僅在開發環境運行
- 建議定期清理快取以避免記憶體洩漏
